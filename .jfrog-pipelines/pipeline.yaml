resources:
  - name: src_repo_conan_examples2
    type: GitRepo
    configuration:
      path: harshkumar1/conan-examples2
      files:
        include: tutorial/consuming_packages/simple_cmake_project
      gitProvider: hk_github
      branches:
        include: ^main$
      cloneProtocol: https
      buildOn:
        commit: true

pipelines:
  - name: demo_conan_pipeline_example
    steps:
      - name: compile
        type: Bash
        configuration:
          runtime:
            type: image
            image:
              custom:
                name: pipelines.jfrog.io/pipelines-runtime-images/pipelines-w19cpp-ckmake
                tag: '1'
          inputResources:
            - name: src_repo_conan_examples2
        execution:
          onStart:
            - pip install conan
          onExecute:
            - cd $res_src_repo_conan_examples2_resourcePath/tutorial/consuming_packages/simple_cmake_project
            - conan profile detect --force
            - conan install . --output-folder=build --build=missing
            - cd build
            - cmake .. -DCMAKE_TOOLCHAIN_FILE=conan_toolchain.cmake -DCMAKE_BUILD_TYPE=Release
            - cmake --build .
          onSuccess:
            - add_run_files $res_src_repo_conan_examples2_resourcePath/tutorial/consuming_packages/simple_cmake_project/build simple_cmake_project_build
      - name: publish
        type: Bash
        configuration:
          inputSteps:
            - name: compile
          integrations:
            - name: hk_artifactory_1
        execution:
          onStart:
            - restore_run_files simple_cmake_project_build simple_cmake_project_build/
          onExecute:
            - echo "publish step"
            - task: jfrog/setup-jfrog-cli@v0.1.0
              input:
                version: "2.26.1"    
            - jf rt upload simple_cmake_project_build/compressor generic-repo-local/${run_number}/